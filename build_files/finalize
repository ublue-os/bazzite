#!/usr/bin/bash

set -eoux pipefail

dnf5 clean all
rm -rf /tmp/* || true
find /var/* -maxdepth 0 -type d \! -name cache -exec rm -fr {} \;
find /var/cache/* -maxdepth 0 -type d \! -name libdnf5 \! -name rpm-ostree -exec rm -fr {} \;
mkdir -p /var/tmp
chmod -R 1777 /var/tmp

# Remove leftover kernel-devel and clean up sources
rpm -e kernel-devel-matched
rpm -e kernel-devel
rpm -e kernel-common
rm -rf /usr/src/kernels/*

ostree container commit
